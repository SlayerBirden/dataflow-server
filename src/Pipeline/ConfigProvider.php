<?php

/**
 * This file is generated by SlayerBirden\DFCodeGeneration
 */

declare(strict_types=1);

namespace SlayerBirden\DataFlowServer\Pipeline;

use Psr\Log\LoggerInterface;
use SlayerBirden\DataFlowServer\Authentication\Middleware\TokenMiddleware;
use SlayerBirden\DataFlowServer\Doctrine\Persistence\EntityManagerRegistry;
use SlayerBirden\DataFlowServer\Domain\Middleware\SetOwnerMiddleware;
use SlayerBirden\DataFlowServer\Domain\Middleware\ValidateOwnerMiddleware;
use SlayerBirden\DataFlowServer\Pipeline\Controller\AddPipeAction;
use SlayerBirden\DataFlowServer\Pipeline\Controller\DeletePipeAction;
use SlayerBirden\DataFlowServer\Pipeline\Factory\InputFilterMiddlewareFactory;
use SlayerBirden\DataFlowServer\Pipeline\Factory\PipeHydratorFactory;
use SlayerBirden\DataFlowServer\Pipeline\Factory\PipeResourceMiddlewareFactory;
use SlayerBirden\DataFlowServer\Stdlib\Middleware\TimestampableInsertMiddleware;
use SlayerBirden\DataFlowServer\Zend\InputFilter\ProxyFilterManagerFactory;
use Zend\Expressive\Helper\BodyParams\BodyParamsMiddleware;
use Zend\ServiceManager\AbstractFactory\ConfigAbstractFactory;

final class ConfigProvider
{
    public function __invoke(): array
    {
        return [
            'doctrine' => $this->getDoctrineConfig(),
            ConfigAbstractFactory::class => $this->getConfigAbstractFactoryConfig(),
            'dependencies' => $this->getDependenciesConfig(),
            'input_filter_specs' => [
                'PipeInputFilter' => $this->getPipeInputFilterSpec(),
            ],
            'routes' => $this->getRoutesConfig(),
        ];
    }

    private function getDoctrineConfig(): array
    {
        return [
            'entity_managers' => [
                'default' => [
                    'paths' => [
                        'src/Pipeline/Entities',
                    ],
                ],
            ],
        ];
    }

    private function getConfigAbstractFactoryConfig(): array
    {
        return [
            AddPipeAction::class => [
                EntityManagerRegistry::class,
                'PipeHydrator',
                LoggerInterface::class,
            ],
            DeletePipeAction::class => [
                EntityManagerRegistry::class,
                'PipeHydrator',
                LoggerInterface::class,
            ],
        ];
    }

    private function getDependenciesConfig(): array
    {
        return [
            'factories' => [
                'PipeHydrator' => PipeHydratorFactory::class,
                'PipeInputFilter' => ProxyFilterManagerFactory::class,
                'PipeInputFilterMiddleware' => InputFilterMiddlewareFactory::class,
                'PipeResourceMiddleware' => PipeResourceMiddlewareFactory::class,
            ],
        ];
    }

    private function getPipeInputFilterSpec(): array
    {
        return [
            'name' => [
                'filters' => [
                    [
                        'name' => 'stringtrim',
                    ],
                ],
                'validators' => [
                    [
                        'name' => 'notempty',
                    ],
                    [
                        'name' => 'stringLength',
                        'options' => [
                            'max' => 255,
                        ],
                    ],
                ],
            ],
            'type' => [
                'filters' => [
                    [
                        'name' => 'stringtrim',
                    ],
                ],
                'validators' => [
                    [
                        'name' => 'notempty',
                    ],
                ],
            ],
        ];
    }

    private function getRoutesConfig(): array
    {
        return [
            [
                'path' => '/pipe',
                'middleware' => [
                    TokenMiddleware::class,
                    BodyParamsMiddleware::class,
                    'PipeInputFilterMiddleware',
                    SetOwnerMiddleware::class,
                    TimestampableInsertMiddleware::class,
                    AddPipeAction::class,
                ],
                'name' => 'add_pipe',
                'allowed_methods' => [
                    'POST',
                ],
            ],
            [
                'path' => '/pipe/{id:\\d+}',
                'middleware' => [
                    TokenMiddleware::class,
                    'PipeResourceMiddleware',
                    ValidateOwnerMiddleware::class,
                    DeletePipeAction::class,
                ],
                'name' => 'delete_pipe',
                'allowed_methods' => [
                    'DELETE',
                ],
            ],
        ];
    }
}
